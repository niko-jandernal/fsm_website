{% extends "base.html" %}
{% block title%} Home  {% endblock %}
{% block content %}

    <link rel="stylesheet" href="../static/styles/homestyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">


{% for post in posts %}
    <div class="post">
        <div class="post-user">
            <div class="user-info">
                <div class="user-icon"><i class='bx bx-user'></i></div>
                <div class="user-name">
                    {{ post.user.username }}
                </div>
            </div>
        </div>
        <div class="post-image">
            <img src="{{ post.image.url }}" alt="{{ post.caption }}">
        </div>
        <div class="post-caption">
            <p>{{ post.user.username }}</p>
            <p>{{ post.caption }}</p>
        </div>

        <button class="like-btn" data-post-id="{{ post.id }}" id="like-btn-{{ post.id }}">
            {% if post.is_liked %}
                <i class='bx bxs-heart' ></i>
            {% else %}
                <i class='bx bx-heart' ></i>
            {% endif %}
            <p id="like-count-{{ post.id }}">{{ post.likes.count }}</p>
        </button>

        <form id="comment-form" data-post-id="{{ post.id }}">
            {% csrf_token %}
            <textarea id="comment-textarea" name="comment" placeholder="Write a comment..."></textarea>
            <button type="submit" class="comment-btn">
                <i class='bx bx-paper-plane'></i>
            </button>
        </form>
        <div id="comments-section">
            {% for comment in post.comments.all %}
                <div class="comment">
                    <p>{{ comment.author }}  {{ comment.content }}</p>
                    <small>{{ comment.date_posted|timesince }} ago</small>
                </div>
            {% endfor %}
        </div>
        <div class="post-date">
            <p>{{ post.date_posted|timesince}} ago</p>
        </div>
     </div>

{% empty %}
    <p>No posts yet.</p>
{% endfor %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
$(document).ready(function(){
    $('.like-btn').click(function(e){
        e.preventDefault();
        var post_id = $(this).data('post-id');
        var btn = $(this); // Reference to the button
        $.ajax({
            type: 'POST',
            url: `/post/${post_id}/like/`,
            data: {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function(response){
                var icon = btn.find('i'); // Find the icon within the button
                var likeText = btn.find('p'); // Find the like text within the button

                // Toggle the icon class based on whether the post is liked
                if(response.is_liked){
                    icon.removeClass('bx bx-heart').addClass('bx bxs-heart'); // Change to filled heart icon
                    likeText.text(response.total_likes ); // Update likes count
                } else {
                    icon.removeClass('bx bxs-heart').addClass('bx bx-heart  '); // Change to outline heart icon
                    likeText.text(response.total_likes); // Update likes count
                }
            },
            error: function(response){
                alert('Something went wrong. Please try again.');
            }
        });
    });
});


$(document).ready(function(){
    $('#comment-form').submit(function(e){
        e.preventDefault();
        var post_id = $(this).data('post-id');
        $.ajax({
            type: 'POST',
            url: `/post/${post_id}/comment/`,
            data: {
                comment: $('#comment-textarea').val(),
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function(response){
                // Append the new comment to the comments section
                // Adjust selectors and HTML structure as needed
                $('#comments-section').append(
                    `<div class="comment"><p>${response.author}: ${response.comment}</p><small>${response.date_posted}</small></div>`
                );
                $('#comment-textarea').val(''); // Clear the textarea
            },
            error: function(response){
                alert('Your comment could not be posted. Please try again.');
            }
        });
    });
});



</script>
{% endblock %}
